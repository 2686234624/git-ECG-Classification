# git-ECG-Classification
一、	概述：
心电图是反映心脏兴奋的电活动过程，它对心脏基本功能及其病理研究方面，具有重要的参考价值。心电图可以分析与鉴别各种心律失常；也可以反映心肌受损的程度和发展过程和心房、心室的功能结构情况。在指导心脏手术进行及指示必要的药物处理上有参考价值。
心电监测技术的作用是可以监测患者的生理参数，从而能够指出某些临危的情况，便于医生采取有效的应急的方案治疗，同时还可以有效的减少并发症的发生。做心电监测通常可以检测心电信号的相关参数，如P，QRS波群等，在心率异常的时候还会及时报警。
机器学习部分实现了对心电信号进行分类，以实现心电异常检测。通过Python开发环境，对采集到的心电信号进行信号处理和分析，并利用二分类模型和五分类模型进行正常和异常的分类。该项目应用了机器学习算法、信号处理技术等多种技术手段，提高了我们对机器学习模型、信号处理、数据挖掘等知识的理解和掌握能力。

二、	项目目标简述与需求分析说明：
2.1.目标简述：
本项目的主要目标是开发一个基于机器学习的心电分类系统，能够对心电信号进行准确的分类，我们利用Mit提供的dat格式的数据集，通过常规机器学习方法以及深度学习方式训练模型，以损失值，准确率，混淆矩阵等评估方式，寻求更高准确率的分类。需要实现以下功能：
1.硬件设备采集心电信号，并对信号进行处理和分析，提取出各种波形特征。
2.开发一个二分类模型，对正常和异常的心电信号进行分类。
3.进一步开发一个五分类模型，对异常心电信号进行更加细致的分类。
4.实现可视化展示，包括心电信号图像、分类结果等。
2.2.需求分析：
本项目通过远程心电监测，可以满足多样化健康医疗服务需求，心电图是一项用于心血管疾病诊断的常规检查项目，但我国真正精通心电图的医生只有约3.6万人，远远不能满足各级医院的临床需求。而心电图最大的优势就是远程传输不失真，我们小组希望通过对远程心电监测，不仅可以实现到帮助医生诊疗，也能实现用户及用户家人的监察，以满足家庭和个人多层次、多样化的健康医疗服务需求。

三、	项目系统设计分析：
3.1.本项目的主体系统架构如下：
1.	数据采集：使用心电信号采集设备，采集患者的心电信号。


2.	峰值定位：读入硬件终端上位机传过来的或者从数据库中读取已经发过来但未处理的心电数据，格式csv文件，shape为（1，8192），通过采样率（fs）512hz计算，可以得知时间为16s，通过对这16s的原始心电数据进行一个R峰峰值提取，找到R峰的位置，以便后续心电信号的分类和处理。
 
3.	截取单周期：提取出心电的R峰以后，按照二分类等模型的数据标准，以R峰为中心，分别向前向后截取185个点（原因：心电的一个周期为0.7~0.8秒这个范围），也就是370个点，约0.72秒，通过以下的混合心拍图发现，这个长度约为一个心电周期，和理论相符。
 
4.	滤波操作：将截取到的心电信号进行滤波操作并将这些特征作为模型输入到二分类模型中。我们选用的方法是小波滤波的方式，通过以下可以发现，经过滤波比未经滤波操作整个图像都光滑了很多，P波等小波相较于未经过滤波操作的心电更加容易识别了，而且可以看出未经过滤波操作的心电信号上面有着很多细小的高频噪声，由此便可以看出滤波的优越性
 
 
5.	送入二分类模型：通过加载已经训练好的二分类模型，直接将以上所得的ndarray心电数据送入二分类模型，二分类模型的具体说明与分析在3.2。
6.	筛除数据：对二分类的结果进行处理，筛掉二分类模型中预测为非正常心电的的数据，预测为正常的数据则送入五分类模型
7.	进行重采样：由于五分类模型训练所使用Mit心电数据集的采样频率为360Hz，而我们本地所采集心电信号的采样频率为512Hz，这就需要我们对频率做一个等值匹配，我们选择的方法是将512Hz心电信号进行一个下采样处理，转化为360Hz的心电信号，以便于五分类模型更好地提取本地的心电特征
 
8.五分类处理：加载已经训练好的五分类模型，将重采样的数据送入模型中，得到softmax输出
9.输出处理：五分类模型的输出是一个softmax的array数组，这种预测结果不直观，所以我们将这个softmax输出首先转化为独热编码，再在独热编码的基础上转化为直观的数组形式。
10.可视化处理：将心电数据进行一些可视化处理，如心率计算，心电走向以及R峰提取进行一个可视化处理，以便后续传入数据库或者直接进行读取
 
11.扩展功能：将心电数据以及机器学习的结果存入数据库，以便医生端和用户端进行查看

3.2.二分类模型：
此模型是一个二分类弱学习器，仅仅只能分出噪声很大的心电和噪声不大的心电，如图：
 
目的是将噪声很大的心电信号都去掉，不送入五分类模型中去，因为噪声大的心电信号送入五分类模型中进行异常分类的意义不大，没有参考的价值，此模型的训练集是由我们本地采集的心电信号（标签值为一）和模拟生成的加入噪声的心电信号（标签值为零，ECG_Stimulate如上）组成，数据预处理仅进行了滤波操作，并没有加入标准化，归一化与PCA处理，在刚开始的时候我们加入了这些数据预处理，发现效果并没有直接进行滤波处理的效果好，经过思考后，分析原因如下：
（1）	归一化容易受到极差的影响，心电数据在这么多数据的情况下，归一化容易受到异常点的影响，故归一化不做考虑。
（2）	标准化：标准化是将数据方差变小，以下是经过滤波和经过滤波再经标准化的心电数据，很容易看出模型更容易区分左边的数据
 
（3）	PCA降维不做考虑，维数降了特征反而变少了，况且这是一个弱学习器，过拟合的情况不需要考虑，故不需要进行降维处理
模型选用：机器学习SVC
选择原因:
①选择机器学习的原因
    (1)训练集的数据量不大,相较于深度学习,这个二分类模型就是一个简单的弱学习器,总之,可以用深度学习提取特征并进行训练,但是是没有必要的
    (2)使用机器学习能够使代码的健壮性更强,虽然这个二分类模型是一个弱学习器,仅可以区分正常心电和加入了高斯噪声的心电,但是完全可以加上很多个弱学习器使整个大模型变成一个强学习器,可以做一个很多弱学习器融合的集成学习,使得模型更加健壮
②选择SVC的原因:
    在使用这个模型之前(two_classification_v1),我们小组也尝试过有监督学习分类算法的其他常规模型:KNN,逻辑回归,决策树,随机森林,但是模型最终的准确率都不如向量机,虽然我们使用的sklearn库将算法封装在里面的,相当于一个黑盒子,但是我们仍需对常见的机器学习算法做一定了解,经过一番思考,我们小组做出如下推测:和KNN,逻辑回归这几类算法将预测值用一个平面或者曲面不同,向量机算法是通过建立一个超平面将目标值所分开,心电数据作为一种时间序列,在我们没有经过波形提取之前,它的峰值出现在哪一个维度本身就是不确定的,就导致了最后所截取的心拍完全交错开来了,所以想要将不同目标的心电用一个平面或者一个曲面分割开来,这几乎是不可能的,所以如果使用这几类模型,评估器只能乱猜了,导致最后的准确路在百分之五十上下波动
但是在使用这个模型之后(two_classification_v2),我认为完全可以使用KNN,logistics regression,因为这一次我们是将心拍最中间的值提取为R峰峰值,这样用平面或者曲面分开是有可能的

3.3.五分类异常分类模型：
1. 将Mit数据集中的19类心拍标签转化为AAMI中的五类，找到标签的位置（R峰），根据标签内容分为AAMI中的五类，再向前向后分别截取130个点，也就是260个点，约0.72秒，约为心电的一个周期，并将截取的数据经过滤波操作写入文件夹中
### 心电分类标准(AAMI)
（1）.AAMI EC57标准简介
ANSL／AAMI EC57：2012 是由美国医疗仪器促进协会(Association for the Advancement of Medical Instrumentation，AAMI)制定的一系列标准，包括心率失常的分类、心律失常分类检测算法的评估标准等等。

AAMI规定心电节拍可以分为五大类：
- N(正常或者束支传导阻滞节拍)
- s(室上性异常节拍)
- V(心室异常节拍)
- F(融合节拍)
- Q(未能分类的节拍)
以及无法识读的u类、辅助无法识读标志的x类和0类

AAMI还规定了心律失常分类检测算法的评估标准，包括算法准确率的计算方法（混淆矩阵），以及准确率(Acc)、灵敏度(sen)、真阳性率(Ppr)等作为衡量分类器分类性能的参数。通过混淆矩阵计算各个参数。
AAMI标准中指出Q类分类的准确率仅供参考，而u、x、0类不是真正的心电节拍，因此最终衡量分类算法的准确率是N、s、V、F类的心电节拍的Acc、Sen、Ppr。
（2）.为什么要应用AAMI标准
规范化，便于横向比较
目前发表的关于心电信号自动分类的论文中，有很大一部分没有应用AAMI标准，而是任意选取5-9个MIT-BIH中数量最多的心拍种类进行分类，导致无法科学有效地横向比较各个算法的优劣，这是当前心电分类领域存在的一个很严重的问题。如果相关研究人员都能应用AAMI标准下的分类标准和评估标准，并且统一使用MIT-BIH中同样的数据作为实验数据，各个算法的横向比较将变得容易很多。
（3）.MIT-BIH数据库的心拍类型 vs AAMI规定的心电种类
AAMI规定的心电种类和MIT- BIH 心电数据库注释的心拍类型是两种临床上的分类方法，因此需要把MIT- BIH 数据库注释的心电节拍类型转换为AAMI的心电种类，转换表格如下
 
总而言之：AAMI分类标准就是
(1)AAMI分类仅有五类,而Mit数据集中的心拍标签却有19类之多,做深度学习肯定分的类别越少,最终预测的结果也就越准确
(2)和以上资料所说的一样,AAMI分类比Mit数据集分类的普适性高,使用程度高
2.读取文件夹中的数据，以此作为训练集，它们的标签就是其对应的文件名的编码lableSet = ['F','N','Q','S','V']对应[0,1,2,3,4]
3.构建深度学习模型：通过观察我们处理的以下数据，我们可以得出，这一段ECG信号既包含了空间特征，又包含了时间特征，但是请注意，我们每一次进来的心电数据都是R峰都是居中的，而且根据高斯分布的规律，它的长度也大都是一个周期的长度，所以关于这段ECG序列的在时间上的特征，我们可以暂不做考虑，如果说要做考虑的话，则可以考虑使用RNN（循环卷积网络）或者LSTM（长短期记忆网络），但是，它在时间上的特征，几乎已经被我们使用波形提取固定住了，所以我们组并没有对它的时间特征进行提取；再通过对这段ECG序列的观察，我们可以看到它有大有小，有高有低，在空间上的特征是十分明显的，所以我们打算对它空间上的特征进行处理，因此我们打算使用卷积神经网络。
卷积神经网络，适合处理，空间数据，一维卷积神经网络也被称为时间延迟神经网络（time delay neural network），可以用来处理一维数据。 CNN的设计思想受到了视觉神经科学的启发，主要由卷积（convolutional layer) 和池化层（pooling layer）组成。卷积层能够保持图像的空间连续性，能将图像的局部特征提取出来，池化层能降低中间隐含层的维度，减少接下来各层的运算量。

 
以下是模型构建的源代码：
 
输入的单个样本的长度为260，四个卷积层，三个池化层进行特征的提取，最后两个全连接层进行分类处理。
4.将经过滤波后的心电数据经过训练集，测试集的划分放入模型中训练，最后的评判标准以准确率，损失值以及混淆矩阵为标准，如下，通过混淆矩阵可以观察到大部分落在对角线上，但是由于2类的数量太少，导致这类没有一个划分在测试集里面
 
 
5.最后将所训练出的模型保存到相应的文件夹里面，注：模型放在中文路径下面加载不出来

四、实验结果与讨论：
在实验过程中，我们采用了多种机器学习算法，包括决策树、支持向量机、神经网络等。在特征提取方面，我们主要采用了深度学习中的CNN网络。经过实验验证，我们得出以下结论：
1.	二分类模型的准确率可以达到99%以上，能够有效地区分正常和加入噪声后的心电信号。
 
2.	五分类模型针对异常心电信号进行异常分类，准确率可以达到99%以上。
见以上3.3.4
3.特征提取对模型的准确率有着重要的影响，选择合适的特征可以极大地提高模型的性能，选择CNN网络对该模型进行分类进行处理有着至关重要的意义。

五、不足与总结：
1.	不足：在机器学习部分仍有很大的完善空间，不足之处主要有以下两点
（1）：五分类数据集分布不平衡，好在最后的准确率和混淆矩阵还看得过去，就没有对Mit数据集进行数据增强处理，如果要把工作做得更完善的话，就可以考虑对Mit所得到的标签数据进行数据增强处理，我们小组想到对心电数据做数据增强处理的具体方法有：用多种滤波的方法进行滤波操作，上下稍微平移数据，对心电加入不同的细微噪声，虽然未完成数据增强这个工作，但数据增强对心电的深度学习以及模型的健壮仍然有着巨大的意义。
（2）导联方式的有细微的差别：我们小组使用的Mit数据集里面心电的导联方式主要有两种：MⅠⅡ导联和V5胸导联，而我们小组采集的信号是使用的三导联方式，虽然可以做近似处理，但是这几者的心电图还是有着细微的差别的，比如在一些小波的显示上以及电压之间也有是着一定的差距的，虽然卷积神经网络可以弥补空间上的特征提取，但如果有改进空间的话应该考虑对心电十二导联的数据集进行一个处理和学习。
（3）心电数据处理的实时性也是我们所关注的，在医疗仪器方面，硬件以及软件的实时性是必须要重视的，假如患者用着我们的系统，但是实时性是跟不上的，比如这会儿已经处于危险状态，而十几二十秒我们整个系统才检测出来，这是不行的，在生命面前，分秒必争！在实时性这点上，不仅需要硬件端串口，蓝牙发送，也需要硬件终端上位机网络端发送至服务器或是数据库，还需要软件端降低代码的时间复杂度，选择调用的AP共同努力来实现。
（4）后续如果能够再进一步完善的话，可以选择将模型部署到边缘设备（如树莓派），在边缘设备进行边缘计算和处理，可以提高网络的速度，减少网络的延迟，同时对第三点的实时性也是有所帮助的。

2.反思
（1）写代码一定不能乱成一团，不然后面一定会因为变量太多被弄晕的，尤其是在jupyter这样的环境里更要注意，后面的cell运行了以后，再运行前面的cell很容易变量与变量之间覆盖掉；减少变量肯定也是一种方法，但是程序大了以后不可避免地需要建立很多变量，最好的方法是模块化编程，写完不同的功能以后最好做一下封装，这样不仅有利于程序的健壮和美观，也使我们编写程序的时候思路更加的清晰。
（2）通过本次课程设计，我们深入了解了机器学习、信号处理等相关技术，并掌握了如何使用Python进行心电异常分类。该项目能够为医生提供一种快速、可靠的心电异常检测方法，具有广泛的应用前景。同时，该项目也提高了理论水平和实践能力，在人工智能领域具有重要的意义。
（3）在做关于机器学习或深度学习的项目的时候，千万不要一味地追求强大的模型而忽略了对原始数据的处理，有时候，对原始数据处理到位了，在建立模型时，反而不需要复杂的模型，比如我们在刚开始的时候，并没有固定R峰的位置，而是随意地截取固定的长度，在前面二分类模型的时候还好，但是送入五分类异常检测就得要考虑时间上的特征，因为此时每个波出现在哪个位置就不确定了，那么就必须要考虑上时间的特征了，而我们后来是先对硬件终端读取的心电信号进行波形提取，以R峰为中心，向前向后分别截取大约半周期的长度，这样进入模型的就是一段一段的单周期序列，这样也就不需考虑时间先后了。
（4）后期如果想要完善并且壮大模型的话，可以在二分类模型后面加上其他模型，目前我们想到的可以加入一个导联脱落检测模型，没加的原因是已经有硬件终端上位机了，抱着单一责任原则的态度，这部分内容不属于我们软件上位机来做，但是如果想要进行模型的健壮，完全可以在二分类模型之后训练多个机器学习分类器。有的时候，多个弱学习器加在一起可能比一个强学习器还强，因为强学习器有过拟合的风险，这可能就是“三个臭皮匠，顶个诸葛亮吧”
（5）导联方式再做一个总结：虽然一直纠结该如何从众多不同的导联方式中选择合适的导联，通过查阅大量的资料，我们找到一种简单而又合理的解释：不同的导联是从身体的不同部位测得的电势，会有粗粒度上的一些不同，就像图像数据中的一些边缘特征，可以在卷积神经网络的前几层提取出来，因此不需要手动选择导联。（但是机器学习不同，机器学习只能学习已经提取出的特征与输出之间的联系，不能自动提取特征，因此需要谨慎选择导联方式）因此打消了我们的顾虑。
